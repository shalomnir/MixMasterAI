{% extends 'base.html' %}

{% block content %}
<div class="space-y-8">
    <div class="flex justify-between items-end mb-2">
        <div>
            <h2 class="text-2xl font-bold text-white mb-0">Menu</h2>
            <p class="text-slate-400 text-sm">Select a drink to pour.</p>
        </div>
        <div class="text-right">
            <!-- Placeholder for filters if needed -->
        </div>
    </div>

    <!-- Classic Cocktails Section -->
    {% if classic_cocktails %}
    <div class="category-section">
        <div class="flex items-center gap-3 mb-4">
            <div class="h-1 w-12 bg-gradient-to-r from-pink-500 to-violet-500 rounded-full"></div>
            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-violet-400">
                Classic Cocktails
            </h3>
            <div class="h-1 flex-grow bg-gradient-to-r from-violet-500/50 to-transparent rounded-full"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            {% for recipe in classic_cocktails %}
            <div onclick='openDrinkModal({{ recipe.id }}, "{{ recipe.name|escape }}", {{ recipe.points_reward }}, {{ recipe.get_ingredients()|tojson|safe }}, {{ recipe.category|tojson|safe }}, "{{ recipe.description|escape if recipe.description else "" }}")'
                class="cocktail-card glass rounded-2xl aspect-square relative overflow-hidden cursor-pointer hover:scale-[1.02] active:scale-95 transition-all transform border border-white/5 flex flex-col items-center justify-center p-4 gap-2">

                <!-- Drink Icon -->
                <div
                    class="flex-shrink-0 w-14 h-14 rounded-full bg-gradient-to-br from-pink-500 to-violet-500 flex items-center justify-center text-2xl shadow-lg">
                    üçπ
                </div>

                <!-- Drink Name Container -->
                <div class="w-full flex flex-col items-center">
                    <h3 class="text-lg font-extrabold text-white text-center line-clamp-1 leading-tight mb-1">{{
                        recipe.name }}</h3>

                    <!-- Description -->
                    <p class="text-xs text-slate-400 text-center line-clamp-2 leading-snug px-1 font-medium">
                        {{ recipe.description|default('', true) }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Highballs Section -->
    {% if highballs %}
    <div class="category-section">
        <div class="flex items-center gap-3 mb-4">
            <div class="h-1 w-12 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full"></div>
            <div class="flex flex-col">
                <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400">
                    Highballs
                </h3>
                <p class="text-[10px] text-slate-400 italic">Add Soda/Tonic after pouring</p>
            </div>
            <div class="h-1 flex-grow bg-gradient-to-r from-blue-500/50 to-transparent rounded-full"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            {% for recipe in highballs %}
            <div onclick='openDrinkModal({{ recipe.id }}, "{{ recipe.name|escape }}", {{ recipe.points_reward }}, {{ recipe.get_ingredients()|tojson|safe }}, {{ recipe.category|tojson|safe }}, "{{ recipe.description|escape if recipe.description else "" }}")'
                class="cocktail-card glass rounded-2xl aspect-square relative overflow-hidden cursor-pointer hover:scale-[1.02] active:scale-95 transition-all transform border border-white/5 flex flex-col items-center justify-center p-4 gap-2">

                <!-- Drink Icon -->
                <div
                    class="flex-shrink-0 w-14 h-14 rounded-full bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-2xl shadow-lg">
                    üçπ
                </div>

                <!-- Drink Name Container -->
                <div class="w-full flex flex-col items-center">
                    <h3 class="text-lg font-extrabold text-white text-center line-clamp-1 leading-tight mb-1">{{
                        recipe.name }}</h3>

                    <!-- Description -->
                    <p class="text-xs text-slate-400 text-center line-clamp-2 leading-snug px-1 font-medium">
                        {{ recipe.description|default('', true) }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Shots Section -->
    {% if shots %}
    <div class="category-section">
        <div class="flex items-center gap-3 mb-4">
            <div class="h-1 w-12 bg-gradient-to-r from-amber-500 to-orange-500 rounded-full"></div>
            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-400">
                Shots
            </h3>
            <div class="h-1 flex-grow bg-gradient-to-r from-orange-500/50 to-transparent rounded-full"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            {% for recipe in shots %}
            <div onclick='openDrinkModal({{ recipe.id }}, "{{ recipe.name|escape }}", {{ recipe.points_reward }}, {{ recipe.get_ingredients()|tojson|safe }}, {{ recipe.category|tojson|safe }}, "{{ recipe.description|escape if recipe.description else "" }}")'
                class="cocktail-card glass rounded-2xl aspect-square relative overflow-hidden cursor-pointer hover:scale-[1.02] active:scale-95 transition-all transform border border-white/5 flex flex-col items-center justify-center p-4 gap-2">

                <!-- Drink Icon -->
                <div
                    class="flex-shrink-0 w-14 h-14 rounded-full bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center text-2xl shadow-lg">
                    üçπ
                </div>

                <!-- Drink Name Container -->
                <div class="w-full flex flex-col items-center">
                    <h3 class="text-lg font-extrabold text-white text-center line-clamp-1 leading-tight mb-1">{{
                        recipe.name }}</h3>

                    <!-- Description -->
                    <p class="text-xs text-slate-400 text-center line-clamp-2 leading-snug px-1 font-medium">
                        {{ recipe.description|default('', true) }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Drink Details Modal -->
<div id="drink-modal" class="fixed inset-0 z-[200] hidden">
    <!-- Backdrop -->
    <div onclick="closeDrinkModal()" class="absolute inset-0 bg-black/80 backdrop-blur-md"></div>

    <!-- Modal Content (Slide up from bottom on mobile) -->
    <div id="modal-content"
        class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:max-w-lg md:bottom-auto md:rounded-3xl glass rounded-t-3xl md:rounded-b-3xl p-8 transform transition-transform duration-300 translate-y-full flex flex-col max-h-[90vh]"
        style="padding-bottom: calc(2rem + env(safe-area-inset-bottom));">

        <!-- Close Button -->
        <button onclick="closeDrinkModal()"
            class="absolute top-4 right-4 w-10 h-10 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition touch-manipulation z-10">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <!-- Fixed Top Section: Icon, Name, Description, Points -->
        <div class="flex-shrink-0">
            <!-- Drink Icon -->
            <div class="flex justify-center mb-4">
                <div
                    class="w-20 h-20 rounded-full bg-gradient-to-br from-pink-500 to-violet-500 flex items-center justify-center text-4xl shadow-lg">
                    üçπ
                </div>
            </div>

            <!-- Drink Name -->
            <h2 id="modal-drink-name" class="text-3xl font-bold text-center text-white mb-3"></h2>

            <!-- Description -->
            <div id="modal-description-container" class="mb-3" style="display: none;">
                <p id="modal-description" class="text-slate-300 text-center text-sm italic"></p>
            </div>

            <!-- Points Badge -->
            <div class="flex justify-center mb-4">
                <div id="modal-points-badge" class="bg-violet-600 px-4 py-1 rounded-full text-sm font-bold"></div>
            </div>
        </div>

        <!-- Scrollable Content Area -->
        <div class="overflow-y-auto flex-grow" style="max-height: 50vh;">

            <!-- Strong Drink Toggle -->
            <div class="mb-3 p-3 bg-slate-800/50 rounded-xl border-2 border-transparent" id="strong-toggle-container">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white font-bold text-sm">Strong Drink üí™</p>
                        <p class="text-slate-400 text-xs">50% more alcohol ‚Ä¢ 2x points</p>
                    </div>
                    <button onclick="toggleStrong()" id="strong-toggle"
                        class="w-16 h-8 rounded-full bg-slate-700 relative transition-all duration-300"
                        aria-label="Toggle strong drink">
                        <div id="toggle-indicator"
                            class="absolute top-1 left-1 w-6 h-6 rounded-full bg-white transition-all duration-300">
                        </div>
                    </button>
                </div>
            </div>

            <!-- Taste Toggle -->
            <div class="mb-4 p-3 bg-slate-800/50 rounded-xl border-2 border-transparent" id="taste-toggle-container">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white font-bold text-sm">Not Sure? Get a Taste ü•Ñ</p>
                        <p class="text-slate-400 text-xs">Small portion ‚Ä¢ Points based on ml</p>
                    </div>
                    <button onclick="toggleTaste()" id="taste-toggle"
                        class="w-16 h-8 rounded-full bg-slate-700 relative transition-all duration-300"
                        aria-label="Toggle taste">
                        <div id="taste-toggle-indicator"
                            class="absolute top-1 left-1 w-6 h-6 rounded-full bg-white transition-all duration-300">
                        </div>
                    </button>
                </div>
            </div>

            <!-- Ingredients List (2-Column Grid) -->
            <div class="mb-4 bg-slate-800/50 rounded-xl p-4">
                <p class="text-slate-300 text-sm font-semibold mb-3">What's in it:</p>
                <div id="modal-ingredients-list" class="grid grid-cols-2 gap-x-4 gap-y-2 text-white text-sm"></div>
                <div class="mt-3 pt-3 border-t border-slate-700 hidden">
                    <p id="modal-total-volume" class="text-slate-400 text-xs"></p>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Button -->
        <div class="flex-shrink-0 mt-4">
            <button onclick="confirmPour()" id="pour-button"
                class="w-full py-4 bg-gradient-to-r from-pink-600 to-violet-600 rounded-xl font-bold text-lg shadow-lg hover:scale-[1.02] active:scale-95 transition-all transform touch-manipulation">
                Pour This Drink
            </button>
        </div>
    </div>
</div>

<!-- Pouring Modal / Overlay -->
<div id="pour-overlay"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center text-center p-8">
    <div class="animate-spin rounded-full h-24 w-24 border-t-4 border-b-4 border-pink-500 mb-8"></div>
    <h2 class="text-3xl font-bold text-white mb-2" id="pouring-title">Pouring...</h2>
    <p class="text-slate-400">Please wait while we mix your drink.</p>
</div>

<!-- Toast Notification -->
<div id="toast-notification"
    class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 hidden animate-bounce">
    <div class="flex items-center space-x-3">
        <span class="text-2xl">üèÅ</span>
        <span id="toast-message" class="font-semibold"></span>
    </div>
</div>

<script>
    let isPouring = false;
    let pollingInterval;
    let currentRecipeId = null;
    let currentRecipeName = '';
    let currentPoints = 0;
    let currentIngredients = {}; // Original recipe ingredients
    let isStrong = false; // Strong drink toggle state
    let isTaste = false; // Taste toggle state
    let pumpData = {}; // Store pump ingredient names
    let glassVolumeMl = 200; // Legacy, replaced by category volumes
    let classicTargetVol = 110;
    let highballTargetVol = 90;
    let shotTargetVol = 40;
    let tasteAmountMl = 30;
    let chaserAmountMl = {{ chaser_amount_ml|default (100) }};
    let currentCategory = 'classic';

    // Fetch pump data and glass volume on page load
    async function loadPumpData() {
        try {
            const response = await fetch('/api/pumps');
            const data = await response.json();
            pumpData = data.pumps || {};
            classicTargetVol = data.classic_target_vol || 110;
            highballTargetVol = data.highball_target_vol || 90;
            shotTargetVol = data.shot_target_vol || 40;
            tasteAmountMl = data.taste_amount_ml || 30;
        } catch (error) {
            console.error('Failed to load pump data:', error);
        }
    }

    // Calculate points based on actual alcohol volume (1 point per 1 ml)
    function calculateAlcoholPoints(calculatedRecipe) {
        let totalAlcoholMl = 0;
        for (const [pumpId, mlAmount] of Object.entries(calculatedRecipe)) {
            const pumpInfo = pumpData[pumpId];
            if (pumpInfo && pumpInfo.is_alcohol) {
                totalAlcoholMl += mlAmount;
            }
        }
        return Math.round(totalAlcoholMl);
    }

    // Calculate proportional recipe based on glass volume and double alcohol setting
    // Calculate proportional recipe based on glass volume OR taste amount
    function calculateProportionalRecipe(originalIngredients, isDouble, isPourTaste) {
        // Step 1: Calculate total from original recipe
        const originalTotal = Object.values(originalIngredients).reduce((sum, ml) => sum + parseFloat(ml), 0);
        if (originalTotal === 0) return {};

        // Step 2: Calculate proportions
        const proportions = {};
        for (const [pumpId, ml] of Object.entries(originalIngredients)) {
            proportions[pumpId] = parseFloat(ml) / originalTotal;
        }

        // Step 3: Determine Base Volume
        // CHASER MODE: Use chaserAmountMl (overrides taste/glass)
        // TASTE MODE: Use tasteAmountMl
        // STANDARD/STRONG: Use glassVolumeMl
        let baseVolume;
        if (isPourTaste) {
            baseVolume = tasteAmountMl;
        } else {
            if (currentCategory === 'highball') {
                baseVolume = highballTargetVol;
            } else if (currentCategory === 'shot') {
                baseVolume = shotTargetVol;
            } else {
                baseVolume = classicTargetVol;
            }
        }

        // Step 4: Calculate actual ML
        const calculated = {};

        for (const [pumpId, proportion] of Object.entries(proportions)) {
            let targetMl = baseVolume * proportion;

            // Apply Strong Drink Modifier (50% more alcohol)
            // Only applies if NOT in tasting mode (Mutual Exclusivity)
            if (isDouble && !isPourTaste) {
                const pumpInfo = pumpData[pumpId];
                if (pumpInfo && pumpInfo.is_alcohol) {
                    targetMl = targetMl * 1.5;
                }
            }

            calculated[pumpId] = targetMl;
        }

        return calculated;
    }

    // Modal functions
    async function openDrinkModal(recipeId, recipeName, points, ingredients, category = 'classic', description = '') {
        currentRecipeId = recipeId;
        currentRecipeName = recipeName;
        currentIngredients = ingredients;
        currentCategory = category;

        // Calculate initial points based on standard pour (no modifiers)
        const standardRecipe = calculateProportionalRecipe(ingredients, false, false);
        currentPoints = calculateAlcoholPoints(standardRecipe);

        // Update modal content
        document.getElementById('modal-drink-name').textContent = recipeName;
        document.getElementById('modal-points-badge').textContent = `${currentPoints} PTS`;

        // Update description (show only if exists)
        const descContainer = document.getElementById('modal-description-container');
        const descElement = document.getElementById('modal-description');
        if (description && description.trim() !== '') {
            descElement.textContent = description;
            descContainer.style.display = 'block';
        } else {
            descContainer.style.display = 'none';
        }

        // Calculate and display recipe
        updateRecipeDisplay();

        // Reset strong toggle
        isStrong = false;
        document.getElementById('strong-toggle').classList.remove('bg-amber-500');
        document.getElementById('strong-toggle').classList.add('bg-slate-700');
        document.getElementById('toggle-indicator').style.transform = 'translateX(0)';
        document.getElementById('strong-toggle-container').classList.remove('border-amber-500');

        // Reset taste toggle
        isTaste = false;
        document.getElementById('taste-toggle').classList.remove('bg-cyan-500');
        document.getElementById('taste-toggle').classList.add('bg-slate-700');
        document.getElementById('taste-toggle-indicator').style.transform = 'translateX(0)';
        document.getElementById('taste-toggle-container').classList.remove('border-cyan-500');
        document.getElementById('taste-toggle-container').classList.remove('border-cyan-500');

        // Reset button UI
        updatePourButtonUI();

        // Show modal with animation
        const modal = document.getElementById('drink-modal');
        const modalContent = document.getElementById('modal-content');
        modal.classList.remove('hidden');

        setTimeout(() => {
            modalContent.classList.remove('translate-y-full');
            modalContent.classList.add('translate-y-0');
        }, 10);
    }

    // Update recipe display based on current settings
    function updateRecipeDisplay() {
        const calculatedRecipe = calculateProportionalRecipe(currentIngredients, isStrong, isTaste);

        // Build ingredients grid with names and ml
        const ingredientsList = document.getElementById('modal-ingredients-list');
        ingredientsList.innerHTML = '';
        let totalMl = 0;

        for (const [pumpId, ml] of Object.entries(calculatedRecipe)) {
            const pumpInfo = pumpData[pumpId];
            const ingredientName = pumpInfo ? pumpInfo.name : `Pump ${pumpId}`;
            const roundedMl = Math.round(ml);
            totalMl += roundedMl;

            // Create grid items for 2-column layout
            // Column 1: Ingredient name
            const nameDiv = document.createElement('div');
            nameDiv.className = 'text-left font-medium';
            nameDiv.textContent = ingredientName;

            // Column 2: Amount
            const amountDiv = document.createElement('div');
            amountDiv.className = 'text-right text-slate-400';
            amountDiv.textContent = `${roundedMl}ml`;

            ingredientsList.appendChild(nameDiv);
            ingredientsList.appendChild(amountDiv);
        }

        // Display total volume
        const totalOz = (totalMl / 29.5735).toFixed(1); // Convert to oz
        document.getElementById('modal-total-volume').textContent = `Total: ${totalMl}ml (~ ${totalOz} oz)`;
    }

    function closeDrinkModal() {
        const modalContent = document.getElementById('modal-content');
        modalContent.classList.add('translate-y-full');
        modalContent.classList.remove('translate-y-0');

        setTimeout(() => {
            document.getElementById('drink-modal').classList.add('hidden');
        }, 300);
    }

    // Helper to update the main Pour Button style based on active toggles
    function updatePourButtonUI() {
        const pourButton = document.getElementById('pour-button');
        if (!pourButton) return;

        // Base classes that are always present
        pourButton.className = 'w-full py-5 rounded-xl font-bold text-xl shadow-lg hover:scale-[1.02] active:scale-95 transition-all transform touch-manipulation text-white transition-colors duration-300';

        if (isStrong) {
            // Strong Mode styling (Red/Orange)
            pourButton.textContent = 'Strong Pour! üí™';
            pourButton.classList.add('bg-gradient-to-r', 'from-red-600', 'to-orange-600');
        } else if (isTaste) {
            // Tasting Mode styling (Blue/Teal)
            pourButton.textContent = 'Tasting Pour ü•Ñ';
            pourButton.classList.add('bg-gradient-to-r', 'from-cyan-500', 'to-blue-600');
        } else {
            // Standard styling (Pink/Violet)
            pourButton.textContent = 'Pour This Drink';
            pourButton.classList.add('bg-gradient-to-r', 'from-pink-600', 'to-violet-600');
        }
    }

    function toggleStrong() {
        // Toggle Strong state
        isStrong = !isStrong;

        // If Strong is turned ON, ensure Taste is OFF
        if (isStrong) {
            isTaste = false;
            // update taste toggle UI manually to off
            const tasteToggle = document.getElementById('taste-toggle');
            const tasteIndicator = document.getElementById('taste-toggle-indicator');
            const tasteContainer = document.getElementById('taste-toggle-container');

            if (tasteToggle) {
                tasteToggle.classList.add('bg-slate-700');
                tasteToggle.classList.remove('bg-cyan-500');
            }
            if (tasteIndicator) tasteIndicator.style.transform = 'translateX(0)';
            if (tasteContainer) tasteContainer.classList.remove('border-cyan-500');
        }

        // Update Strong Toggle UI
        const toggle = document.getElementById('strong-toggle');
        const indicator = document.getElementById('toggle-indicator');
        const container = document.getElementById('strong-toggle-container');
        const pointsBadge = document.getElementById('modal-points-badge');

        if (isStrong) {
            toggle.classList.remove('bg-slate-700');
            toggle.classList.add('bg-amber-500');
            indicator.style.transform = 'translateX(2rem)';
            container.classList.add('border-amber-500');

            // Calculate points for strong mode
            const strongRecipe = calculateProportionalRecipe(currentIngredients, true, false);
            const basePoints = calculateAlcoholPoints(strongRecipe);
            pointsBadge.textContent = `${basePoints * 2} PTS (STRONG!)`;
        } else {
            toggle.classList.add('bg-slate-700');
            toggle.classList.remove('bg-amber-500');
            indicator.style.transform = 'translateX(0)';
            container.classList.remove('border-amber-500');

            // Calculate points for normal mode
            const normalRecipe = calculateProportionalRecipe(currentIngredients, false, false);
            const basePoints = calculateAlcoholPoints(normalRecipe);
            pointsBadge.textContent = `${basePoints} PTS`;
        }

        // Update Button and Recipe
        updatePourButtonUI();
        updateRecipeDisplay();
    }

    function toggleTaste() {
        // Toggle Taste state
        isTaste = !isTaste;

        // If Taste is turned ON, ensure Strong is OFF
        if (isTaste) {
            isStrong = false;
            // update strong toggle UI manually to off
            const strongToggle = document.getElementById('strong-toggle');
            const strongIndicator = document.getElementById('toggle-indicator');
            const strongContainer = document.getElementById('strong-toggle-container');
            const pointsBadge = document.getElementById('modal-points-badge');

            if (strongToggle) {
                strongToggle.classList.add('bg-slate-700');
                strongToggle.classList.remove('bg-amber-500');
            }
            if (strongIndicator) strongIndicator.style.transform = 'translateX(0)';
            if (strongContainer) strongContainer.classList.remove('border-amber-500');
            if (pointsBadge) pointsBadge.textContent = `${currentPoints} PTS`;
        }

        // Update Taste Toggle UI
        const toggle = document.getElementById('taste-toggle');
        const indicator = document.getElementById('taste-toggle-indicator');
        const container = document.getElementById('taste-toggle-container');
        const pointsBadge = document.getElementById('modal-points-badge');

        if (isTaste) {
            toggle.classList.remove('bg-slate-700');
            toggle.classList.add('bg-cyan-500');
            indicator.style.transform = 'translateX(2rem)';
            container.classList.add('border-cyan-500');

            // Calculate points for tasting mode
            const tasteRecipe = calculateProportionalRecipe(currentIngredients, false, true);
            const tastePoints = calculateAlcoholPoints(tasteRecipe);
            if (pointsBadge) pointsBadge.textContent = `${tastePoints} PTS (Taste)`;

        } else {
            toggle.classList.add('bg-slate-700');
            toggle.classList.remove('bg-cyan-500');
            indicator.style.transform = 'translateX(0)';
            container.classList.remove('border-cyan-500');

            // Restore standard points
            const normalRecipe = calculateProportionalRecipe(currentIngredients, false, false);
            const basePoints = calculateAlcoholPoints(normalRecipe);
            if (pointsBadge) pointsBadge.textContent = `${basePoints} PTS`;
        }

        // Update Button and Recipe
        updatePourButtonUI();
        updateRecipeDisplay();
    }

    async function confirmPour() {
        if (isPouring || !currentRecipeId) return;

        // Hide bottom navigation during pour
        const bottomNav = document.getElementById('bottom-nav');
        if (bottomNav) bottomNav.classList.add('hidden');

        closeDrinkModal();
        isPouring = true;

        // Calculate recalculated recipe for pouring duration
        const recalculatedIngredients = calculateProportionalRecipe(currentIngredients, isStrong, isTaste);

        // Calculate total pour duration using pump calibration (PARALLEL EXECUTION)
        const pumpDurations = [];
        for (const [pumpId, mlAmount] of Object.entries(recalculatedIngredients)) {
            const pumpInfo = pumpData[pumpId];
            if (!pumpInfo) continue;

            // Convert ML to Seconds using calibration (default 3s per 50ml)
            const secondsPer50ml = pumpInfo.seconds_per_50ml || 3.0;
            const pourSeconds = (mlAmount / 50.0) * secondsPer50ml;
            pumpDurations.push(pourSeconds);
        }

        // Total duration is the longest pump since they run in parallel
        const totalDuration = pumpDurations.length > 0 ? Math.max(...pumpDurations) : 0;

        // Show progress animation
        showProgressAnimation(totalDuration);

        try {
            const response = await fetch(`/pour/${currentRecipeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    is_strong: isStrong,
                    is_taste: isTaste
                })
            });

            const data = await response.json();

            if (data.status === 'success') {
                // Highball Notification (NEW)
                if (data.is_highball) {
                    setTimeout(() => {
                        showHighballToast();
                    }, 1500);
                }

                // Animation will complete, then show success
                // isPouring will be reset by status polling when backend completes
                // Success is handled in showProgressAnimation
            } else if (data.status === 'error') {
                hideProgressAnimation();
                showToast(data.message);
                // Don't manually set isPouring = false
                // Let status polling handle it
            } else {
                hideProgressAnimation();
                showToast('Something went wrong!');
                // Don't manually set isPouring = false
                // Let status polling handle it
            }

        } catch (error) {
            hideProgressAnimation();
            showToast('Failed to connect to the machine.');
            // Don't manually set isPouring = false
            // Let status polling handle it
        }
    }

    function showProgressAnimation(durationSeconds) {
        const overlay = document.getElementById('pour-overlay');
        const title = document.getElementById('pouring-title');
        const loadingSpinner = overlay.querySelector('.animate-spin');

        // Create progress UI
        overlay.innerHTML = `
            <div class="w-full max-w-md px-8">
                <!-- Drink Icon -->
                <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-pink-500 to-violet-500 flex items-center justify-center text-6xl shadow-lg mb-8 animate-pulse">
                    üçπ
                </div>
                
                
                <h2 class="text-3xl font-bold text-white mb-2 text-center">Pouring ${currentRecipeName}${isStrong ? ' ü•É' : ''}</h2>
                <p class="text-slate-400 text-center mb-8">Please wait while we mix your drink...</p>
                
                <!-- Progress Bar -->
                <div class="w-full bg-slate-800 rounded-full h-4 mb-4 overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-pink-500 to-violet-500 rounded-full transition-all duration-100" style="width: 0%"></div>
                </div>
                
                <!-- Percentage & Time Remaining -->
                <div class="flex justify-between items-center text-white">
                    <p id="progress-percentage" class="text-2xl font-bold">0%</p>
                    <p id="time-remaining" class="text-lg text-slate-400">~${Math.ceil(durationSeconds)}s left</p>
                </div>
            </div>
        `;

        overlay.classList.remove('hidden');

        // Animate progress
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-percentage');
        const startTime = Date.now();
        const duration = durationSeconds * 1000; // Convert to ms

        const animationInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min((elapsed / duration) * 100, 100);
            const remaining = Math.max(0, Math.ceil((duration - elapsed) / 1000));

            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;

            // Update time remaining
            const timeDisplay = document.getElementById('time-remaining');
            if (timeDisplay) {
                timeDisplay.textContent = remaining > 0 ? `~${remaining}s left` : 'Finishing up...';
            }

            if (progress >= 100) {
                clearInterval(animationInterval);
                // Show success message immediately
                showSuccessMessage();
            }
        }, 50); // Update every 50ms for smooth animation
    }

    function showSuccessMessage() {
        const overlay = document.getElementById('pour-overlay');

        // Fetch user's rank information
        fetch('/api/user/rank')
            .then(response => response.json())
            .then(rankData => {
                let rankInfo = '';

                if (rankData.status === 'success') {
                    const position = rankData.position;
                    const suffix = position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th';

                    if (rankData.player_ahead) {
                        rankInfo = `
                            <div class="mb-6 p-4 bg-gradient-to-r from-violet-900/40 to-pink-900/40 rounded-xl border border-white/10">
                                <p class="text-slate-300 text-sm mb-1">üèÜ Leaderboard Position</p>
                                <p class="text-white text-xl font-bold">You are now ${position}${suffix} place!</p>
                                <p class="text-slate-400 text-sm mt-1">Just ${rankData.player_ahead.points_behind} points behind ${rankData.player_ahead.nickname}</p>
                            </div>
                        `;
                    } else {
                        // User is in 1st place
                        rankInfo = `
                            <div class="mb-6 p-4 bg-gradient-to-r from-yellow-900/40 to-amber-900/40 rounded-xl border border-yellow-500/30">
                                <p class="text-yellow-300 text-sm mb-1">üëë Leaderboard Position</p>
                                <p class="text-white text-xl font-bold">You're in 1st place!</p>
                                <p class="text-yellow-400 text-sm mt-1">You're leading the pack! üéâ</p>
                            </div>
                        `;
                    }
                }

                overlay.innerHTML = `
                    <div class="relative text-center max-w-md mx-auto">
                        <!-- Close Button (X) -->
                        <button onclick="hideSuccessScreen()" 
                            class="absolute -top-4 -right-4 w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition touch-manipulation z-10 border-2 border-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>

                        <!-- Success Icon (Checkmark) -->
                        <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center shadow-lg mb-8">
                            <svg class="w-20 h-20 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        
                        <!-- Premium Success Message -->
                        <div class="mb-8 animate-fade-in-up">
                            <h2 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-violet-400 mb-3" style="font-family: 'Outfit', sans-serif;">Success!</h2>
                            <p class="text-2xl text-white font-light">Enjoy your drink ‚ú®</p>
                        </div>

                        <!-- Points Earned -->
                        <div class="mb-6 transform transition-all hover:scale-105 duration-300">
                            <div class="inline-flex items-center gap-3 bg-white/10 backdrop-blur-md px-6 py-3 rounded-2xl border border-white/10 shadow-xl">
                                <span class="text-3xl">ü™ô</span>
                                <div class="text-left">
                                    <p class="text-xs text-slate-400 uppercase tracking-widest font-semibold">Earned</p>
                                    <p class="text-xl font-bold text-white">+${(() => {
                        const earnedRecipe = calculateProportionalRecipe(currentIngredients, isStrong, isTaste);
                        const basePoints = calculateAlcoholPoints(earnedRecipe);
                        return isStrong ? basePoints * 2 : basePoints;
                    })()} Points</p>
                                </div>
                            </div>
                        </div>

                        <!-- Rank Information -->
                        ${rankInfo}
                        
                        <!-- Go to Rank Button -->
                        <button onclick="window.location.href='/leaderboard'" 
                            class="w-full max-w-xs group relative overflow-hidden px-8 py-4 bg-gradient-to-r from-pink-600 to-violet-600 rounded-2xl font-bold text-lg text-white shadow-2xl shadow-purple-500/30 transition-all transform hover:scale-[1.02] active:scale-95">
                            <span class="relative z-10 flex items-center justify-center gap-2">
                                Go to Rank
                                <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                            </span>
                            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        </button>
                    </div>
                `;
            })
            .catch(error => {
                // Fallback if rank fetch fails - show basic success without rank
                overlay.innerHTML = `
                    <div class="relative text-center max-w-md mx-auto">
                        <!-- Close Button (X) -->
                        <button onclick="hideSuccessScreen()" 
                            class="absolute -top-4 -right-4 w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition touch-manipulation z-10 border-2 border-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>

                        <!-- Success Icon (Checkmark) -->
                        <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center shadow-lg mb-8">
                            <svg class="w-20 h-20 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        
                        <!-- Premium Success Message -->
                        <div class="mb-8 animate-fade-in-up">
                            <h2 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-violet-400 mb-3" style="font-family: 'Outfit', sans-serif;">Success!</h2>
                            <p class="text-2xl text-white font-light">Enjoy your drink ‚ú®</p>
                        </div>

                        <!-- Points Earned -->
                        <div class="mb-10 transform transition-all hover:scale-105 duration-300">
                            <div class="inline-flex items-center gap-3 bg-white/10 backdrop-blur-md px-6 py-3 rounded-2xl border border-white/10 shadow-xl">
                                <span class="text-3xl">ü™ô</span>
                                <div class="text-left">
                                    <p class="text-xs text-slate-400 uppercase tracking-widest font-semibold">Earned</p>
                                    <p class="text-xl font-bold text-white">+${(() => {
                        const earnedRecipe = calculateProportionalRecipe(currentIngredients, isStrong, isTaste);
                        const basePoints = calculateAlcoholPoints(earnedRecipe);
                        return isStrong ? basePoints * 2 : basePoints;
                    })()} Points</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Go to Rank Button -->
                        <button onclick="window.location.href='/leaderboard'" 
                            class="w-full max-w-xs group relative overflow-hidden px-8 py-4 bg-gradient-to-r from-pink-600 to-violet-600 rounded-2xl font-bold text-lg text-white shadow-2xl shadow-purple-500/30 transition-all transform hover:scale-[1.02] active:scale-95">
                            <span class="relative z-10 flex items-center justify-center gap-2">
                                Go to Rank
                                <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                            </span>
                            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        </button>
                    </div>
                `;
            });
    }

    function hideSuccessScreen() {
        const overlay = document.getElementById('pour-overlay');
        overlay.classList.add('hidden');
        // Reset pouring state
        isPouring = false;
        // Show bottom navigation again
        const bottomNav = document.getElementById('bottom-nav');
        if (bottomNav) bottomNav.classList.remove('hidden');
    }

    function hideProgressAnimation() {
        const overlay = document.getElementById('pour-overlay');
        overlay.classList.add('hidden');
        // Reset to original spinner content
        overlay.innerHTML = `
            <div class="animate-spin rounded-full h-24 w-24 border-t-4 border-b-4 border-pink-500 mb-8"></div>
            <h2 class="text-3xl font-bold text-white mb-2" id="pouring-title">Pouring...</h2>
            <p class="text-slate-400">Please wait while we mix your drink.</p>
        `;
    }

    // Poll machine status every 1000ms
    function startStatusPolling() {
        pollingInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateUIState(data.is_pouring);
            } catch (error) {
                // Silently fail for production
            }
        }, 1000);
    }

    // Update UI based on machine state
    function updateUIState(machineIsBusy) {
        // CRITICAL: Sync local isPouring with backend state
        isPouring = machineIsBusy;

        // Dashboard cards should ALWAYS remain clickable and interactive
        // Remove any previous locking code for cards

        // Only lock the Pour button inside the modal when machine is busy
        const pourButton = document.getElementById('pour-button');

        if (pourButton) {
            if (machineIsBusy) {
                pourButton.disabled = true;
                pourButton.textContent = ' Machine Busy... üç∏';
                pourButton.classList.add('opacity-50', 'cursor-not-allowed');
                pourButton.classList.remove('hover:scale-[1.02]');
            } else {
                pourButton.disabled = false;
                pourButton.classList.remove('opacity-50', 'cursor-not-allowed');
                pourButton.classList.add('hover:scale-[1.02]');

                // Restore button style based on current toggles
                updatePourButtonUI();
            }
        }
    }

    // Show toast notification
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        toastMessage.innerText = message;
        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Show Highball notification (NEW)
    function showHighballToast() {
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        toastMessage.innerText = `Base poured! Please top up with Soda/Tonic for the perfect balance. ü•§`;
        toast.classList.remove('hidden', 'bg-red-500');
        toast.classList.add('bg-blue-600');

        setTimeout(() => {
            toast.classList.add('hidden');
            toast.classList.remove('bg-blue-600');
            toast.classList.add('bg-red-500');
        }, 8000);
    }

    // Start polling when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadPumpData(); // Load ingredient names
        startStatusPolling();
    });

    // Clean up polling when page unloads
    window.addEventListener('beforeunload', () => {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
    });
</script>
{% endblock %}