<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Cocktail Mixer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">

    <!-- API Configuration (auto-detects local vs production) -->
    <script src="js/config.js"></script>
</head>

<body class="bg-slate-900 text-white min-h-[100dvh] flex flex-col overflow-hidden">

    <!-- Global Brand Header -->
    <header class="px-4 pt-4 text-center pb-2">
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">
            MixMasterAI
        </h1>
    </header>

    <div class="flex-1 overflow-hidden flex items-center justify-center p-4"
        style="padding-bottom: calc(1rem + env(safe-area-inset-bottom));">
        <div class="glass rounded-3xl p-10 md:p-14 max-w-lg w-full border border-white/10 shadow-2xl">
            <div class="text-center space-y-8">
                <div class="space-y-3">
                    <h1
                        class="text-5xl md:text-6xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">
                        Pour It Up.
                    </h1>
                    <p id="event-subtitle" class="text-slate-400 text-base md:text-lg">The AI-powered cocktail
                        experience.</p>
                </div>

                <!-- Error Message Display -->
                <div id="error-message"
                    class="hidden bg-red-900/30 border border-red-500/50 text-red-300 px-4 py-3 rounded-xl text-sm">
                </div>

                <!-- Registration/Login Form -->
                <form id="registration-form" class="space-y-5">
                    <div>
                        <label for="nickname" class="block text-base text-slate-400 mb-3">Who are you?</label>
                        <input type="text" name="nickname" id="nickname" required autofocus
                            placeholder="Enter your nickname"
                            class="w-full px-5 py-4 text-lg rounded-xl bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition">
                    </div>

                    <!-- Admin Password Field (hidden by default) -->
                    <div id="admin-password-container" class="hidden">
                        <label for="admin-password" class="block text-base text-slate-400 mb-3">Admin Password</label>
                        <input type="password" name="admin-password" id="admin-password"
                            placeholder="Enter admin password"
                            class="w-full px-5 py-4 text-lg rounded-xl bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent transition">
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full py-5 text-xl bg-gradient-to-r from-pink-600 to-violet-600 rounded-xl font-bold shadow-lg hover:scale-[1.02] transition transform active:scale-95">
                        Start Mixing
                    </button>
                </form>

                <!-- Recovery Link -->
                <div class="pt-4 border-t border-slate-700">
                    <p class="text-slate-500 text-sm md:text-base mb-3">Lost your session?</p>
                    <a href="recovery.html"
                        class="text-pink-400 hover:text-pink-300 text-base font-semibold transition-colors">
                        → Recover Account with Key
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- API Client -->
    <script src="js/api.js"></script>

    <script>
        // Check if already logged in
        if (api.isAuthenticated()) {
            window.location.href = 'menu.html';
        }

        // Load and display event name
        (async function () {
            try {
                const settings = await api.getSettings();
                if (settings.current_event_name) {
                    document.getElementById('event-subtitle').textContent = `Welcome to ${settings.current_event_name}`;
                }
            } catch (e) {
                console.log('Could not load event name');
            }
        })();

        // Show admin password field logic - modified for Transient Bypass
        const nicknameInput = document.getElementById('nickname');
        const adminPasswordContainer = document.getElementById('admin-password-container');
        const submitBtn = document.getElementById('submit-btn');

        nicknameInput.addEventListener('input', function () {
            if (this.value === 'Admin2001') {
                // BYPASS UI: Hide password, change button
                adminPasswordContainer.classList.add('hidden');
                submitBtn.textContent = 'Go to Dashboard';
                submitBtn.classList.add('from-pink-500', 'to-orange-500'); // distinct color
                submitBtn.classList.remove('from-pink-600', 'to-violet-600');
            } else {
                adminPasswordContainer.classList.add('hidden');
                submitBtn.textContent = 'Start Mixing';
                submitBtn.classList.remove('from-pink-500', 'to-orange-500');
                submitBtn.classList.add('from-pink-600', 'to-violet-600');
            }
        });

        // Form submission
        document.getElementById('registration-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const errorDiv = document.getElementById('error-message');
            const nickname = nicknameInput.value.trim();
            const adminPassword = document.getElementById('admin-password').value;

            // Disable button during submission
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');

            try {
                let response;

                if (nickname === 'Admin2001') {
                    // TRANSIENT BYPASS: Admin2001
                    // No password check required for this specific dev bypass as requested
                    sessionStorage.setItem('cocktail_auth_token', 'admin-session-token');
                    sessionStorage.setItem('cocktail_user', JSON.stringify({
                        nickname: 'Admin',
                        is_admin: true
                    }));
                    window.location.href = 'admin/dashboard.html';
                    return;
                } else {
                    // Try to register new user first
                    try {
                        response = await api.register(nickname);
                    } catch (err) {
                        // If registration fails (user exists), try login
                        if (err.message.includes('already taken')) {
                            // Show error - user should use recovery
                            throw err;
                        }
                        throw err;
                    }
                }

                if (response && response.status === 'success') {
                    // Recovery key is now accessed via recovery.html if needed
                    window.location.href = 'menu.html';
                }
            } catch (error) {
                const message = error.isServerDown
                    ? '⚠️ Server is offline. Please ensure the backend is running.'
                    : error.message;
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                nicknameInput.focus();
                nicknameInput.select();
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Start Mixing';
            }
        });
    </script>

</body>

</html>